/**
 * script.js
 * @author wupengju
 * @GitHub: https://github.com/wupengju/The-question-bank-script
 * @description 给本学院题库所写的自动刷题的脚本
 */
!function(a){"use strict";var b=function(a){return a=b.detectOptions(a),a!==!1?new b.fn.init(a):void 0};b.fn=b.prototype={constructor:b,version:"0.1.1",init:function(a){return this.timer=null,this.$mainFrame=this.setMainFrame(a.arrFrames),this.mainFrameWindow=this.$mainFrame.window,this.validateStr=a.validateStr,this.$chapter=this.mainFrameWindow.document.getElementById(a.chapterSelector),this.$promptInfo=this.mainFrameWindow.document.getElementById(a.promptInfoSelector),this.$chapterOptions=this.$chapter.getElementsByTagName("option"),this.arrChapters=this.setArrChapters(),this.curChapterIndex=this.setCurChapterIndex(),this.arrErrorChapters=a.arrErrorChapters||[],this.startChapterIndex=0,this.endChapterIndex=null,this.correctRate=.95,this.curChapterAllErrors=0,this.curErrorTotalQuestions=0,this.chapterCount=0,this}},b.fn.init.prototype=b.fn,b.addDefaultOptions=function(a,b){var d,e,c={arrFrames:["topmain","main"],validateStr:"此章节下的程序已读取结束",chapterSelector:"cChapter",promptInfoSelector:"divInfo",arrErrorChapters:[3]};if(1===arguments.length)return c;for(d=0,e=b.length;e>d;d++)c[b[d]]=a[b[d]];return c},b.detectOptions=function(a){var c=[],d=!1,e=[];return void 0===a?b.addDefaultOptions(a):b.detectDataTypes(a,"Object")?("arrFrames"in a&&c.push(b.detectDataTypes(a.arrFrames,"Array")),"validateStr"in a&&c.push(b.detectDataTypes(a.validateStr,"String")),"chapterSelector"in a&&c.push(b.detectDataTypes(a.chapterSelector,"String")),"promptInfoSelector"in a&&c.push(b.detectDataTypes(a.promptInfoSelector,"String")),"arrErrorChapters"in a&&c.push(b.detectDataTypes(a.arrErrorChapters,"Array")),d=c.every(function(a){return a===!0?!0:!1}),d?(e=Object.keys(a),e.length<5&&(a=b.addDefaultOptions(a,e)),a):(console.log("传入的参数不符合规范."),!1)):(console.log("请传入对象参数."),!1)},b.detectDataTypes=function(a,b){return Object.prototype.toString.apply(a)==="[object "+b+"]"?!0:!1},b.trigger=function(a,b){a.fireEvent?a.fireEvent(b):a[b]()},b.fn.setMainFrame=function(b){var d,e,c=a;for(d=0,e=b.length;e>d;d++)c=c.frames[b[d]];return c},b.fn.setArrChapters=function(){var d,e,a=null,b=[],c=0;for(d=0,e=this.$chapterOptions.length;e>d;d++)a=this.$chapterOptions[d],c=parseInt(a.value,10),b.push({chapterName:a.innerText,chapterValue:c,chapterProNum:0,chapterAllErrors:0,finishSign:!1});return b},b.fn.setCurChapterIndex=function(){var a=parseInt(this.$chapter.value,10),b=0;return this.arrChapters.forEach(function(c,d){b=c.chapterValue===a?d:b}),b},b.fn.rewriteCurChapterIndex=function(a){this.curChapterIndex=a?a:this.setCurChapterIndex()},b.fn.getChapterProNum=function(a,b){function e(a){return new Promise(function(b,c){var e="",f=null;try{e="<cTest><cProgram>"+a+"</cProgram><cQuestionIndex>0</cQuestionIndex></cTest>",f=d.$mainFrame.CExam.CPractice.GetJSONTest(e),f=JSON.parse(f.value),b(parseInt(f.CQuestion.CQuestionCount,10))}catch(g){c(g)}})}var c=0,d=this,f=new Promise(function(b,c){var e,f;try{e=a+"",f=d.$mainFrame.CExam.CPractice.GetJSONProgramList(e),b(JSON.parse(f.value))}catch(g){c(g)}});f.then(function(a){return a}).then(function(a){var g,h,f=[];for(g=0,h=a.length;h>g;g++)f.push(e(a[g].CProgramID));Promise.all(f).then(function(){var a=[].slice.apply(arguments);a=a.reduce(function(a,b){return a+b}),c=a.reduce(function(a,b){return a+b}),d.arrChapters[b].chapterProNum=c,d.curChapterAllErrors=d.arrChapters[b].chapterAllErrors=Math.floor(d.arrChapters[b].chapterProNum*(1-d.correctRate))}).catch(function(a){throw a})}).catch(function(a){console.log(a)})},b.fn.validateEnd=function(){return this.$promptInfo.innerText.indexOf(this.validateStr)>-1?!0:!1},b.fn.toSetChapter=function(a){this.$chapter.value=this.arrChapters[a].chapterValue,this.getChapterProNum(this.$chapter.value,a),b.trigger(this.$chapter,"onchange"),this.dealErrorChapter(),this.isEnd()===!0?clearInterval(this.timer):this.autoGetAnswer(3e3)},b.fn.toNextChapter=function(){this.curErrorTotalQuestions=0,this.curChapterAllErrors=0,this.arrChapters[this.curChapterIndex].finishSign=!0,this.curChapterIndex++,this.toSetChapter(this.curChapterIndex)},b.fn.changeSection=function(){},b.fn.dealErrorChapter=function(){var a=this.curChapterIndex;this.arrErrorChapters.indexOf(++a)>-1&&this.toNextChapter()},b.fn.getAnswer=function(){var a=["A","B","C","D"],c=this,d=new Promise(function(b,d){var h,e="",f=null,g=null;try{for(h=0;3>=h;h++)if(e="<cTestParam><cQuestion>"+c.$mainFrame.cQuestionID.value+"</cQuestion><cUserAnswer>"+a[h]+"</cUserAnswer></cTestParam>",f=c.$mainFrame.CExam.CPractice.IsOrNotTrue(e),g=null,f.value){c.validateEnd()?g=!1:0!==c.chapterCount&&0===c.chapterCount%5&&c.curErrorTotalQuestions<c.curChapterAllErrors?(g=void 0!==a[++h]?a[h]:a[--h],c.curErrorTotalQuestions++):g=a[h],b(g);break}}catch(i){d(i)}});d.then(function(a){a?(c.$mainFrame.makeChoice(a),c.chapterCount++,0===c.chapterCount%6&&c.curErrorTotalQuestions<=c.curChapterAllErrors&&(c.curErrorTotalQuestions=c.curErrorTotalQuestions===c.curChapterAllErrors?++c.curErrorTotalQuestions:c.curErrorTotalQuestions,b.trigger(c.mainFrameWindow.document.getElementsByClassName("normalButton")[1],"onclick"))):(clearInterval(c.timer),c.toNextChapter())}).catch(function(a){console.log(a)})},b.fn.autoGetAnswer=function(a){var b=this;clearInterval(this.timer),this.timer=setInterval(function(){b.getAnswer()},a)},b.fn.printScriptUsage=function(){console.log("\n/*\n*	 		  #####  #####    # #\n*	 		   #      #      #   #\n*	  #	  #  #   #      # #\n*	   # #    # # ———— #\n*\n* GitHub: https://github.com/wupengju/The-question-bank-script\n* 浏览器支持：http://caniuse.com/#search=Promise\n* \n* 自动刷题脚本的使用说明\n* 启动执行脚本：\n* 	1. answer.start() ：均使用默认参数刷题章节数从当前章节直到刷完为止 和 正确率为 95%\n* 	2. answer.start(1, 2) ：自定义刷题章节数 1-2\n* 	3. answer.start(90) ：自定义正确率位 90%\n* 	4. answer.start(1, 2, 90) ：自定义刷题章节数 1-2 和 正确率位 90%\n* 	5. answer.start(90, 1, 2) ：自定义正确率位 90% 和 刷题章节数 1-2\n* 重新执行脚本：\n* 	answer.reStart();\n* 暂停执行脚本：\n* 	answer.pause();\n* 停止执行脚本：\n* 	answer.stop();\n*/")},b.fn.start=function(){function d(a){for(var c=0,d=a.length;d>c;c++)if(!b.detectDataTypes(a[c],"Number"))return!1;return!0}function e(b,c){return b>=0&&a>=b&&c>=0&&a>=c&&c>=b?!0:!1}function f(a){return a>=90&&99>=a?!0:!1}function g(a,b,c){return 3===arguments.length&&d(arguments)&&f(a)&&e(b,c)?!0:!1}function h(a,b,d){c.startChapterIndex=a-1,c.endChapterIndex=b-1,c.correctRate=d}function i(a){c.rewriteCurChapterIndex(a),c.toSetChapter(a)}var a=this.$chapterOptions.length,c=this;return this.$chapter.addEventListener("change",function(){c.rewriteCurChapterIndex(),c.dealErrorChapter(),c.isEnd()}),0===arguments.length?(h(0,a-1,.95),i(this.startChapterIndex),void 0):1===arguments.length&&d(arguments)&&f(arguments[0])?(h(0,a-1,(.01*arguments[0]).toFixed(2)),i(this.startChapterIndex),void 0):2===arguments.length&&d(arguments)&&e(arguments[0],arguments[1])?(h(Math.ceil(arguments[0]),Math.floor(arguments[1]),.95),i(this.startChapterIndex),void 0):g(arguments[0],arguments[1],arguments[2])?(h(Math.ceil(arguments[1]),Math.floor(arguments[2]),(.01*arguments[0]).toFixed(2)),i(this.startChapterIndex),void 0):g(arguments[2],arguments[0],arguments[1])?(h(Math.ceil(arguments[0]),Math.floor(arguments[1]),(.01*arguments[2]).toFixed(2)),i(this.startChapterIndex),void 0):(console.log("请输入符合规范的开始调用参数."),!1)},b.fn.reStart=function(){this.autoGetAnswer(3e3)},b.fn.isEnd=function(){return this.curChapterIndex>this.endChapterIndex||this.curChapterIndex===this.endChapterIndex&&this.validateEnd()?(clearInterval(this.timer),console.log("本次自动刷题完成!"),!0):void 0},b.fn.stop=b.fn.pause=function(){clearInterval(this.timer)},a.Answer=b}(window),function(a){"use strict";var c=null;c=Answer({arrErrorChapters:[3]}),c.printScriptUsage(),a.answer=c}(window);